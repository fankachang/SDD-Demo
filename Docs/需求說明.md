# 程式版本發佈網站 — 需求說明（MVP）

版本：v1.0.0
語言：繁體中文（zh-TW）

簡短敘述：建立一個簡潔的程式版本發佈系統，使用者於新版本發佈時，經由系統發送公告郵件給特定收件人（可支援 CC/BCC），並提供後台管理介面維護收件清單與可發佈程式清單。

目標：提供最小可行產品（MVP），讓內部或管理者能在三步驟內完成版本公告並寄送給指定收件人，具備基本管理與稽核能力。

**MVP 範圍（優先級）**
- P0（必須）：建立發佈三步驟流程、寄送郵件、收件人管理、程式列表管理、發送紀錄查詢。
- P1（可選/下一步）：支援群組/群組規則、CSV 匯入收件人、簡易權限管理介面（管理/發佈者）。
- P2（未來）：多語系、整合第三方郵件服務進階設定、Webhook 與通知渠道（SMS、Slack）。

---

**使用者流程（UI 與步驟）**
1. 步驟1：建立發佈
   - 欄位：發佈程式名稱（必填，從程式列表選擇）、發佈程式版本（必填，文字）、使用者配合事項（可富文字）
   - 輸入後按「下一步」進入預覽。
2. 步驟2：檢視（預覽）
   - 顯示郵件標題、內文預覽、收件人與 CC/BCC 預覽、可回到步驟1編輯。
3. 步驟3：發送
   - 選擇收件人清單（單一或多選，支援 CC/BCC）、點擊「發送」後顯示即時狀態並記錄結果。

**後台管理介面（最小必要功能）**
- 收件人管理（CRUD）：新增/編輯/刪除聯絡人，欄位：姓名、郵件、所屬群組（可選）
- 群組管理（可選）：建立收件群組，便於一次選取
- CC / BCC 規則：在發送時可切換收件類型
- 可發佈程式列表（CRUD）：新增/編輯/刪除程式名稱（顯示於發佈 form 的下拉）
- 發送紀錄：時間、操作使用者、程式名稱、版本、收件人列表、發送結果（成功/失敗 + 失敗原因）

**非功能性需求**
- 可用性：流程最少化，使用者在 3 步內完成發佈。
- 可擴展性：系統架構允許未來整合第三方郵件服務（例如 SendGrid、SES）或外部通知渠道。
- 安全性：授權驗證（僅授權使用者能發送或管理收件人）；敏感資料加密存儲（例如 API key）；操作日誌稽核。
- 可追蹤性：完整發送紀錄與查詢，支援搜尋與過濾。

資料庫與遷移：
- 初期 DB：可使用 SQLite 作為輕量開發與測試用資料庫。
- 可遷移性：系統需設計為可遷移至 MS-SQL 或 MySQL（或其他關聯式 DB）。建議使用 ORM 與 migration 工具（例如 SQLAlchemy + Alembic、TypeORM + migrations、或使用 Flyway）來管理 schema 變更與遷移流程。

---

**驗收準則（明確、可測試）**
- 使用者能按三步驟輸入、預覽並寄出郵件，收件人收到內容（P0）。
- 管理介面能新增/編輯/刪除收件人與程式列表，變更即時生效（P0）。
- 每次發送會在發送紀錄中儲存時間、發送者、收件人、狀態（P0）。
- 若郵件無法送達，系統會在紀錄顯示失敗原因（P1）。

---

**使用者故事（至少 6 個）**
1. 作為發佈者，我可以在發佈表單輸入程式名稱、版本與配合事項，並進行下一步預覽，這樣我能確認內容是否正確後才發送。 (驗收：表單驗證、預覽顯示正確)
2. 作為發佈者，我可以選擇收件人、設定 CC 或 BCC，並將郵件寄出給指定對象。 (驗收：郵件成功送達、收件人正確)
3. 作為管理者，我可以新增/編輯/刪除收件人與群組，並在發佈時選取。 (驗收：管理 CRUD 成功，發佈選單能讀取)
4. 作為管理者，我可以管理可發佈程式列表，使發佈者能從中選擇程式名稱。 (驗收：程式列表 CRUD 成功，表單可選取)
5. 作為系統管理者，我可以查看每次發送的紀錄與狀態，以便稽核或調查問題。 (驗收：能根據時間/程式/使用者查詢紀錄)
6. 作為測試人員，我可以在開發環境模擬發送並檢查失敗時的錯誤訊息與重試機制（P1）。 (驗收：模擬失敗並紀錄)

---

**最小 API 設計建議（RESTful，示例）**
- POST /api/releases — 建立一個發佈（payload: program_id, version, notes, recipients: {to:[], cc:[], bcc:[]}）
- GET /api/releases — 列表發佈項目（支援 filter: program_id、date range）
- GET /api/releases/{id} — 取得單一發佈詳情
- POST /api/releases/{id}/send — 觸發寄送（可使用相同 payload 或僅觸發）
- GET /api/contacts — 收件人列表
- POST /api/contacts — 新增收件人
- PATCH /api/contacts/{id} — 編輯收件人
- DELETE /api/contacts/{id} — 刪除收件人
- GET /api/programs — 可發佈程式清單
- POST /api/programs — 新增程式
- GET /api/logs — 發送紀錄

回傳格式建議：JSON，包含 status, data, error message。

認證：使用簡單的 token-based auth（如 JWT）於 Authorization header。

---

**最小資料庫 Schema（建議欄位）**
1) users
   - id (PK)
   - email
   - name
   - role (admin/publisher)
   - created_at, updated_at

2) programs
   - id (PK)
   - name (unique)
   - description (optional)
   - created_at, updated_at

3) contacts
   - id (PK)
   - name
   - email
   - group_id (nullable)
   - created_by, created_at, updated_at

4) releases
   - id (PK)
   - program_id (FK)
   - version
   - notes (text)
   - created_by (user id)
   - status (draft/previewed/sent)
   - created_at, updated_at

5) release_recipients
   - id (PK)
   - release_id (FK)
   - contact_id (FK) nullable
   - email (string, copy of email for audit)
   - recipient_type (to/cc/bcc)

6) send_logs
   - id (PK)
   - release_id (FK)
   - sent_at
   - result (success/failure)
   - detail (nullable，用來存下第三方錯誤回應)

---

**發佈郵件範本（可直接使用）**
標題：{program_name} 已發佈新版本 — v{version}

內文：
親愛的同仁／使用者，您好：

我們已於 {date} 發佈 {program_name} 新版本：v{version}

主要更新與注意事項：
{notes}

請依照上方說明進行相應配合事項。如有問題請回覆此郵件或聯絡負責人：{sender}

— 系統自動發送

（變數說明：{program_name}, {version}, {notes}, {date}, {sender}, 可附上 {release_url}）

---

**介面草圖說明（文字 + 簡易 ascii wireframe）**
1) 發佈者介面（3 步驟）
   - Step 1 — 輸入表單
     [程式名稱 ▼]  
     [版本輸入框]  
     [使用者配合事項: textarea]
     [下一步]
   - Step 2 — 預覽
     [郵件標題]
     [郵件內文預覽]
     [收件人選擇：To/CC/BCC]
     [返回編輯] [發送]
   - Step 3 — 狀態
     發送中 → 發送結果（成功 / 失敗）

2) 管理者介面
   - 收件人管理頁：清單 + 新增按鈕 + 搜尋 + 編輯/刪除動作
   - 程式列表管理頁：清單 + 新增/編輯/刪除
   - 發送紀錄頁：時間/程式/版本/發送者/狀態/詳細訊息

---

**測試案例（要點）**
E2E
- 新增程式，建立發佈 -> 預覽 -> 選取收件人 -> 發送 -> 收件者收到郵件
- 測試 CC/BCC：寄送時 CC 與 BCC 欄位正確，BCC 收件人不在 To/CC 顯示
- 發送失敗模擬：當郵件服務回傳錯誤時，發送紀錄顯示失敗與錯誤訊息

單元測試
- 表單驗證：缺少必填欄位會阻止進入預覽
- API：POST /api/releases 輸入驗證、建立 release 與 recipients
- DB：release_recipients 與 send_logs 正確斷言

---

**限制與假設**
- MVP 僅支援郵件（不包含 SMS 或其他通知渠道）。
- 認證設定將以設定檔（.ini）管理，初期不實作完整 OAuth；系統讀取 .ini 以取得必要的帳號或授權設定。
- 系統初期僅支援繁體中文（zh-TW）。

---

補充：若要我把此文件放入專案 README 的指定位置或建立相關 API skeleton、前端樣板或快速 demo，我可以繼續把 P0 功能 scaffold 出來。

---

**設定檔範例（.ini）**

下列為系統初期使用的範例設定檔（config.ini），示範放置帳號／密碼與郵件設定（初期不使用 OAuth）。敏感資訊（例如密碼或 API key）請視情況以環境變數或加密方式管理。

```ini
[auth]
# 最簡單的認證設定：可放公司預設帳號與密碼（初期不使用 OAuth）
account_email = your.account@company.example
password = PLACEHOLDER_PASSWORD

[smtp]
# SMTP 設定（用於寄送郵件）
host = smtp.example.com
port = 587
username = smtp-user
password = smtp-password
use_tls = true

[app]
# 發送者名稱與信箱
sender_name = Release Bot
sender_email = noreply@company.example
# 其他可自訂的預設值
default_from = noreply@company.example
preview_base_url = https://releases.example.com
```

說明：
- `auth.account_email`、`auth.password`：若採用內部帳號授權，可在 ini 放置預設帳號或密碼（建議以環境變數或密文替代）。
- 不採用 OAuth：本專案初期僅需簡單的 `auth.account_email` 與 `auth.password` 供系統認證使用。
- `smtp.*`：用於寄送郵件的主機設定；若使用第三方郵件服務，請依服務設定填寫。
- `app.*`：系統內部使用的預設值（例如發件人、預覽連結等）。